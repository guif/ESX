#!/bin/sh

DATASTORE_ORIGEN="HDD_datastore1"
DATASTORE_REMOTE="SSD_datastore1"
BASE_VM="$1"
NEW_VM="$2"

SRC="/vmfs/volumes/$DATASTORE_ORIGEN/$BASE_VM"
DST="/vmfs/volumes/$DATASTORE_REMOTE/$NEW_VM"
VMX_DST="$2.vmx"
VMX_SRC="$1.vmx"

echo 'Recuperar ID VMs actuales'
BASE_VMID=$(vim-cmd vmsvc/getallvms | awk -v vm="$BASE_VM" '$2==vm {print $1}')
if [ -z "$BASE_VMID" ]; then
    echo "ERROR: No se ha encontrado la VM base: $BASE_VM"
    exit 1
fi

echo "Copiar VM base: ${BASE_VMID},${BASE_VM}"
cp -r "$SRC" "$DST"

cd $DST/

echo 'Renombrar VMX'
cp -rp "$DST/$BASE_VM.vmx" "$VMX"

echo 'Forzar displayName correcto'
if grep -q '^displayName' "$VMX"; then
    sed -i "s/^displayName = \".*\"/displayName = \"$NEW_VM\"/" "$VMX"
else
    echo "displayName = \"$NEW_VM\"" >> "$VMX"
fi

echo 'Limpiar MACs'
sed -i '/ethernet.*address/d' "$VMX"

echo 'Eliminar cualquier uuid.bios existente'
sed -i '/^uuid.bios/d' "$VMX"

echo 'Forzar creaciÃ³n de UUID nuevo al arrancar'
if grep -q '^uuid.action' "$VMX"; then
    sed -i 's/^uuid.action = ".*"/uuid.action = "create"/' "$VMX"
else
    echo 'uuid.action = "create"' >> "$VMX"
fi

echo 'Registrar VM'
vim-cmd solo/registervm "$VMX"

echo 'Verificar'
vim-cmd vmsvc/getallvms
